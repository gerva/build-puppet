#!/usr/bin/env python
### Compressed module sources ###
module_sources = [('util', 'eJxlkM0KwjAQhO99iqWnClJQigfBl/AsSNJsmwWblOzWvr5N4l81t2RnZ+YLDaMPAlaxvZHegian\nuCUqCoMdsFU7lkCur3hzLGA55RllCg7EYhqnVfBdfkha4DJJQ1Y+veuoXmxqQz2yVJscoQ/NnzeD\nVoyHBtC13qDZwkxiQRTdov1sSZBH1SIoZ+C0BA3+jmaV+gKp9V5ds10MD7HiWJWniys/DRLnNPwW\n4QS17gJ3DEzevZHzaryusRPY9/8tcQ8W+3WH\n'), ('util.file', 'eJzNVk1v4zYQvftXTF0EkQNXbYz2soAPRVpgCxTbYre3xcKhRcriRiIFkoqTf983pL4iZ/ewp/Uh\ndjgzj/Nm3oy0Xq/fqrpVjsrOFEFb4ylYqoSRtaJS44+FVUTLer1e6aa1LlBtTydtTluyfku+6oKu\nt4jyVa2PWwqqaTl2VTrb0J01pT79K5zHNX38e3GeH6+AR/sBNT+p8Dd+KpcdDkY06nDYrFZSlVTY\nphVOZQx+u4357TZvVoQPkuutYFApuJqgTPBkSwpnG32Rayu8V5K0IaXh5kj4GI4PiJpEOdFHKMxF\nobzXx6EarQiVz+kPC7MgDzqg2QMYoR8V+eDAoU9Ve2tQIEvSkrGBOo+CGqqFO3HNOSeuKkfrkrTX\nxgdhipHhUXiVAHua/Ik2lIsTHhyv3fWW/nOd2nwBbPcVsN0cbHcBFq84jAXdp4PcKSGzyWO39NjN\nPZwKnTMXUPtFaGqz1E4VwbpnaCQI0MjGExSzK0v9NHWd3ifogHyZNzf/hEaYCSaKgXGisXX2UUuI\n4KxrWQgnI1KC3XJLNdrDU3Bfeyqt/fnmKNw9DX2qdABBYZ6zj2WujPRnCCnrs4I/2srysj6vtQ/I\nYUp+82nsDosBSFMfoP1cOWddtr6zXS2jR6mNpJsrz4BXfk1XlA15TqAvCgzMYVTaZ65t5l0Bbx+2\n8aixUu1ja8cC3uGY4MWUo1+LGVLukVWM2W809M97AUNBQTcQvi5HLMgsKmWoTtoF+cXtI/EhcGI+\nC2HDImThAUWHmUek6itx67smKydOgybQ7g9vf//pNu6muAoWqyEO9X15v+USV+qJG9iIMDYbre7X\nWs7XDHpvx4nhaTlep+NzxWhcjondsbbFA09Em8bht9vdze0vu18ndr0aouMUF2MR8TCeVHnXShFU\nFj1fdj1H6lKfMN7ZUBRRqkNnam0e4ljzHp3qkww0GEifjHWGOx416IdBiuWRWHbmOpB6gqCHygT3\n/GZOAXrn3Zhrz5Jf3DguG0yHszZE+fq0wH0/LWdRT5niGWJbac9mrtUlUpyzCHFpn7rU5/XZapOl\nu8vNq+4vKtZe+gDJNUyOUSazqr16eT8cl4WPdvVUqDbQPx/+5BpvaRb2I/3FHVC0fmexioqqf/a6\nac7X82or3hXG8gLdvbw8KeIr2TmhvZppZDGqkNAkE3aon+PMjhsCDniMsVREfNBbJ7BhNUbKNUpq\nCDRtigob2DF7uCbFpOBBQKVEk5s2ym8/vjLkzYPn37w090Pv8Jvdspjc5rU9Y4+fsziPkUScSH43\nyUuZphR3XZ9xeBE87ZM+l+TBvY6dy/rjvjKrVLjaCsnPLLzALKWeTsFo8YqTzTYgn6Zt8HGI/rSh\nH/Y0/Tv1rB/xd9ao+cgnlD4fvDAN6aQvPMdUfJ1DFdr0DT/R1UNzpzyw3g69c9Z/b2IHZ/aEkS0w\nNxdJ9iFI58J3nnufykXyB6joeyHAqXwTh6O19fdCgnNR4jLkNSL/A0blzyc=\n'), ('util.commands', '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\nD6Mr0w==\n'), ('util.retry', 'eJyNVsuu2zYQXVdfMXBxYdkVBN8ANwsjLlIUTVCgyCrLADYlUTYRiXT5iHNR9N87Q1LUw25RL2xy\nODycMzwzpuivSluwoudZq1UPrZO1VaozIMLSTbOryeLEalbzitVfs8HSqfNZyHOGv3AYZuWZ2z9w\nyHV+PErW8+Nxk2UNb0Fzq19zVluhZAHMWt5frTm8FGA6zq8Ux+HtroCefT+Olpct2fzeI/9ek1VJ\nc8h/G8bFpsggfeqOM+muh09KcjxEn9F1U8DXmx/+9fdm751Xq9WvrOvgFMJZA6NjRe96UC1aY3Br\nnx0DTlrRgbBgXF1z3pjxSGTGXGeROVgFLyWcUuxrEAbshYN0fcU1IRteK9kYcr0xYbMfKm5vnMuU\njmIB+HYHTDbQKFd1ZOKsvoRsDFsKdEvRzGnMMrkuAU7LPPoQGVh37ThuSTgpu0SAIe+Lcl0DFYea\nufPFlvB7CyMMKKSpyVXilzI8AXXCWN6AkI/OZpqDZsKggxfgcBsFZe0VbgJvqBqxoqvoe94IZnn3\n6sM4xTv3XK5afRMNelHWarxiViEzvDkCS0ieR9fNwYC1FkkghcSeEAfCnxTJyfVcWpOAYohwZYZC\nwwsTITevyulBjKGwCE7zP53QKKh7JAwRD9OoD4xIEgOfeMTxZejXJQU3bO24MQm5TDgnEvra0z8F\n1Yc8D5fs1SRqSwJJUVDgRAGUnIgJjachhWusGL9ARLH2B3us5810TSqbqCs9ukZb8BXtvNDh3dgG\n9qN81LlseOXO+Wru/dSAT4CX3NS8gifIZ76T/rIJZ0tsV89+dLsIzImEd4dUgePhKNf9pLWEaIRs\nVb7yWt4D9RCqyieDSrAX32/2OBsaThhHZPgxRPdlhgmQWqKxOqddmzAMEDiRMexUB9w6jULw2/It\neRWw3Ub/5Boq7a513lOKCU6cSO9jce9hVdDsSMwPn7Xj82jwIuPF7hfEUjfO73bgDTzK+L8m+qP4\nRnkmQUnMKaVxKrxZdqhLLM8bFfIz7P7HeR8Y6qKJyvE33KTeXfFWUeMiT1yiWEaB3UGTtfTr+X94\njfEdJuMtvLnzXJCZKf2e2BJ75j7zRm74n+NGYyskqntRARJ+otJJ/+fCF/Y2aGwQYphFOYb96/Ua\nfsG/tlppZrEnYAbje2BTYrtlPbUmZ9g5cng/godk0YGtUhMllWWZLX3To+J5t5s+K553I0rFdL7Z\nz2BihFnyOSbIY4s6UxgnddrJtvf+bRSs07fAdCu5XPEdtKzQ/aNqDtkgvPhsCZviwyX8IMYk0w8v\n238WV5AtjroPMXu8Grln/wDA0B8t\n'), ('util.git', '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\n')]

### Load the compressed module sources ###
import sys, imp
for name, source in module_sources:
    source = source.decode("base64").decode("zlib")
    mod = imp.new_module(name)
    exec source in mod.__dict__
    sys.modules[name] = mod

### Original script follows ###
#!/usr/bin/python
"""%prog [-p|--props-file] [-r|--rev revision] [-b|--branch branch]
         [-s|--shared-dir shared_dir] repo [dest]

Tool to do safe operations with git.

revision/branch on commandline will override those in props-file"""

# Import snippet to find tools lib
import os
import site
site.addsitedir(os.path.join(os.path.dirname(os.path.realpath(__file__)),
                             "../../lib/python"))

from util.git import git

if __name__ == '__main__':
    from optparse import OptionParser
    import logging

    parser = OptionParser(__doc__)
    parser.set_defaults(
        revision=os.environ.get('GIT_REV'),
        branch=os.environ.get('GIT_BRANCH', None),
        propsfile=os.environ.get('PROPERTIES_FILE'),
        loglevel=logging.INFO,
        shared_dir=os.environ.get('GIT_SHARE_BASE_DIR'),
        mirrors=None,
    )
    parser.add_option("-r", "--rev", dest="revision", help="which revision to update to")
    parser.add_option("-b", "--branch", dest="branch", help="which branch to update to")
    parser.add_option("-p", "--props-file", dest="propsfile",
                      help="build json file containing revision information")
    parser.add_option("-s", "--shared-dir", dest="shared_dir",
                      help="clone to a shared directory")
    parser.add_option("--mirror", dest="mirrors", action="append",
                      help="add a mirror to try cloning/pulling from before repo")
    parser.add_option("-v", "--verbose", dest="loglevel", action="store_const", const=logging.DEBUG)

    options, args = parser.parse_args()

    logging.basicConfig(level=options.loglevel, format="%(asctime)s %(message)s")

    if len(args) not in (1, 2):
        parser.error("Invalid number of arguments")

    repo = args[0]
    if len(args) == 2:
        dest = args[1]
    else:
        dest = os.path.basename(repo)

    # Parse propsfile
    if options.propsfile:
        try:
            import json
            assert json
        except ImportError:
            import simplejson as json

        js = json.load(open(options.propsfile))
        if options.revision is None:
            options.revision = js['sourcestamp']['revision']
        if options.branch is None:
            options.branch = js['sourcestamp']['branch']

    got_revision = git(repo, dest, options.branch, options.revision,
                       shareBase=options.shared_dir,
                       mirrors=options.mirrors,
                       )

    print "Got revision %s" % got_revision
