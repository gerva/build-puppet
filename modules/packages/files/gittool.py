#!/usr/bin/env python
### Compressed module sources ###
module_sources = [('util', 'eJxlkM0KwjAQhO99iqWnClJQigfBl/AsSNJsmwWblOzWvr5N4l81t2RnZ+YLDaMPAlaxvZHegian\nuCUqCoMdsFU7lkCur3hzLGA55RllCg7EYhqnVfBdfkha4DJJQ1Y+veuoXmxqQz2yVJscoQ/NnzeD\nVoyHBtC13qDZwkxiQRTdov1sSZBH1SIoZ+C0BA3+jmaV+gKp9V5ds10MD7HiWJWniys/DRLnNPwW\n4QS17gJ3DEzevZHzaryusRPY9/8tcQ8W+3WH\n'), ('util.file', 'eJzNVk1v4zYQvftXTF0EkQNXbYz2soAPRVpgCxTbYre3xcKhRcriRiIFkoqTf983pL4iZ/ewp/Uh\ndjgzj/Nm3oy0Xq/fqrpVjsrOFEFb4ylYqoSRtaJS44+FVUTLer1e6aa1LlBtTydtTluyfku+6oKu\nt4jyVa2PWwqqaTl2VTrb0J01pT79K5zHNX38e3GeH6+AR/sBNT+p8Dd+KpcdDkY06nDYrFZSlVTY\nphVOZQx+u4357TZvVoQPkuutYFApuJqgTPBkSwpnG32Rayu8V5K0IaXh5kj4GI4PiJpEOdFHKMxF\nobzXx6EarQiVz+kPC7MgDzqg2QMYoR8V+eDAoU9Ve2tQIEvSkrGBOo+CGqqFO3HNOSeuKkfrkrTX\nxgdhipHhUXiVAHua/Ik2lIsTHhyv3fWW/nOd2nwBbPcVsN0cbHcBFq84jAXdp4PcKSGzyWO39NjN\nPZwKnTMXUPtFaGqz1E4VwbpnaCQI0MjGExSzK0v9NHWd3ifogHyZNzf/hEaYCSaKgXGisXX2UUuI\n4KxrWQgnI1KC3XJLNdrDU3Bfeyqt/fnmKNw9DX2qdABBYZ6zj2WujPRnCCnrs4I/2srysj6vtQ/I\nYUp+82nsDosBSFMfoP1cOWddtr6zXS2jR6mNpJsrz4BXfk1XlA15TqAvCgzMYVTaZ65t5l0Bbx+2\n8aixUu1ja8cC3uGY4MWUo1+LGVLukVWM2W809M97AUNBQTcQvi5HLMgsKmWoTtoF+cXtI/EhcGI+\nC2HDImThAUWHmUek6itx67smKydOgybQ7g9vf//pNu6muAoWqyEO9X15v+USV+qJG9iIMDYbre7X\nWs7XDHpvx4nhaTlep+NzxWhcjondsbbFA09Em8bht9vdze0vu18ndr0aouMUF2MR8TCeVHnXShFU\nFj1fdj1H6lKfMN7ZUBRRqkNnam0e4ljzHp3qkww0GEifjHWGOx416IdBiuWRWHbmOpB6gqCHygT3\n/GZOAXrn3Zhrz5Jf3DguG0yHszZE+fq0wH0/LWdRT5niGWJbac9mrtUlUpyzCHFpn7rU5/XZapOl\nu8vNq+4vKtZe+gDJNUyOUSazqr16eT8cl4WPdvVUqDbQPx/+5BpvaRb2I/3FHVC0fmexioqqf/a6\nac7X82or3hXG8gLdvbw8KeIr2TmhvZppZDGqkNAkE3aon+PMjhsCDniMsVREfNBbJ7BhNUbKNUpq\nCDRtigob2DF7uCbFpOBBQKVEk5s2ym8/vjLkzYPn37w090Pv8Jvdspjc5rU9Y4+fsziPkUScSH43\nyUuZphR3XZ9xeBE87ZM+l+TBvY6dy/rjvjKrVLjaCsnPLLzALKWeTsFo8YqTzTYgn6Zt8HGI/rSh\nH/Y0/Tv1rB/xd9ao+cgnlD4fvDAN6aQvPMdUfJ1DFdr0DT/R1UNzpzyw3g69c9Z/b2IHZ/aEkS0w\nNxdJ9iFI58J3nnufykXyB6joeyHAqXwTh6O19fdCgnNR4jLkNSL/A0blzyc=\n'), ('util.commands', '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\nD6Mr0w==\n'), ('util.retry', 'eJyNVsuu2zYQXVdfMXBxYdkVBN8ANwsjLlIUTVCgyCrLADYlUTYRiXT5iHNR9N87Q1LUw25RL2xy\nODycMzwzpuivSluwoudZq1UPrZO1VaozIMLSTbOryeLEalbzitVfs8HSqfNZyHOGv3AYZuWZ2z9w\nyHV+PErW8+Nxk2UNb0Fzq19zVluhZAHMWt5frTm8FGA6zq8Ux+HtroCefT+Olpct2fzeI/9ek1VJ\nc8h/G8bFpsggfeqOM+muh09KcjxEn9F1U8DXmx/+9fdm751Xq9WvrOvgFMJZA6NjRe96UC1aY3Br\nnx0DTlrRgbBgXF1z3pjxSGTGXGeROVgFLyWcUuxrEAbshYN0fcU1IRteK9kYcr0xYbMfKm5vnMuU\njmIB+HYHTDbQKFd1ZOKsvoRsDFsKdEvRzGnMMrkuAU7LPPoQGVh37ThuSTgpu0SAIe+Lcl0DFYea\nufPFlvB7CyMMKKSpyVXilzI8AXXCWN6AkI/OZpqDZsKggxfgcBsFZe0VbgJvqBqxoqvoe94IZnn3\n6sM4xTv3XK5afRMNelHWarxiViEzvDkCS0ieR9fNwYC1FkkghcSeEAfCnxTJyfVcWpOAYohwZYZC\nwwsTITevyulBjKGwCE7zP53QKKh7JAwRD9OoD4xIEgOfeMTxZejXJQU3bO24MQm5TDgnEvra0z8F\n1Yc8D5fs1SRqSwJJUVDgRAGUnIgJjachhWusGL9ARLH2B3us5810TSqbqCs9ukZb8BXtvNDh3dgG\n9qN81LlseOXO+Wru/dSAT4CX3NS8gifIZ76T/rIJZ0tsV89+dLsIzImEd4dUgePhKNf9pLWEaIRs\nVb7yWt4D9RCqyieDSrAX32/2OBsaThhHZPgxRPdlhgmQWqKxOqddmzAMEDiRMexUB9w6jULw2/It\neRWw3Ub/5Boq7a513lOKCU6cSO9jce9hVdDsSMwPn7Xj82jwIuPF7hfEUjfO73bgDTzK+L8m+qP4\nRnkmQUnMKaVxKrxZdqhLLM8bFfIz7P7HeR8Y6qKJyvE33KTeXfFWUeMiT1yiWEaB3UGTtfTr+X94\njfEdJuMtvLnzXJCZKf2e2BJ75j7zRm74n+NGYyskqntRARJ+otJJ/+fCF/Y2aGwQYphFOYb96/Ua\nfsG/tlppZrEnYAbje2BTYrtlPbUmZ9g5cng/godk0YGtUhMllWWZLX3To+J5t5s+K553I0rFdL7Z\nz2BihFnyOSbIY4s6UxgnddrJtvf+bRSs07fAdCu5XPEdtKzQ/aNqDtkgvPhsCZviwyX8IMYk0w8v\n238WV5AtjroPMXu8Grln/wDA0B8t\n'), ('util.git', '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\no4z5+1cvbsehD0F7WThv9X4yHf0btJSjDQ==\n')]

### Load the compressed module sources ###
import sys, imp
for name, source in module_sources:
    source = source.decode("base64").decode("zlib")
    mod = imp.new_module(name)
    exec source in mod.__dict__
    sys.modules[name] = mod

### Original script follows ###
#!/usr/bin/python
"""%prog [-p|--props-file] [-r|--rev revision] [-b|--branch branch]
         [-s|--shared-dir shared_dir] repo [dest]

Tool to do safe operations with git.

revision/branch on commandline will override those in props-file"""

# Import snippet to find tools lib
import os
import site
site.addsitedir(os.path.join(os.path.dirname(os.path.realpath(__file__)),
                             "../../lib/python"))

from util.git import git

if __name__ == '__main__':
    from optparse import OptionParser
    import logging

    parser = OptionParser(__doc__)
    parser.set_defaults(
        revision=os.environ.get('GIT_REV'),
        branch=os.environ.get('GIT_BRANCH', None),
        propsfile=os.environ.get('PROPERTIES_FILE'),
        loglevel=logging.INFO,
        shared_dir=os.environ.get('GIT_SHARE_BASE_DIR'),
        mirrors=None,
    )
    parser.add_option("-r", "--rev", dest="revision", help="which revision to update to")
    parser.add_option("-b", "--branch", dest="branch", help="which branch to update to")
    parser.add_option("-p", "--props-file", dest="propsfile",
                      help="build json file containing revision information")
    parser.add_option("-s", "--shared-dir", dest="shared_dir",
                      help="clone to a shared directory")
    parser.add_option("--mirror", dest="mirrors", action="append",
                      help="add a mirror to try cloning/pulling from before repo")
    parser.add_option("-v", "--verbose", dest="loglevel", action="store_const", const=logging.DEBUG)

    options, args = parser.parse_args()

    logging.basicConfig(level=options.loglevel, format="%(asctime)s %(message)s")

    if len(args) not in (1, 2):
        parser.error("Invalid number of arguments")

    repo = args[0]
    if len(args) == 2:
        dest = args[1]
    else:
        dest = os.path.basename(repo)

    # Parse propsfile
    if options.propsfile:
        try:
            import json
            assert json
        except ImportError:
            import simplejson as json

        js = json.load(open(options.propsfile))
        if options.revision is None:
            options.revision = js['sourcestamp']['revision']
        if options.branch is None:
            options.branch = js['sourcestamp']['branch']

    got_revision = git(repo, dest, options.branch, options.revision,
                       shareBase=options.shared_dir,
                       mirrors=options.mirrors,
                       )

    print "Got revision %s" % got_revision
