<% # This Source Code Form is subject to the terms of the Mozilla Public
   # License, v. 2.0. If a copy of the MPL was not distributed with this
   # file, You can obtain one at http://mozilla.org/MPL/2.0/.

suffix = distribution + " " + components.join(" ")
-%>
# Managed by puppet
deb http://<%= data_server %>/<%= url_path -%> <%= suffix %>
<% if data_servers.respond_to?('shuffle') -%>
# all available puppetagain masters (if any)
<%

# we need to "randomly" shuffle this list, but deterministically per host so
# that we're not constantly re-writing this file.  So we seed the rng with the
# ip address, being careful to re-seed it with something random afterward so
# the rest of puppet doesn't become deterministic
old_seed = rand()
srand(ipaddress.sub('.', '').to_i)

data_servers.shuffle.each do |mirror_server|
    # note that this will not catch 'repos' vs. a master fqdn; there's
    # no harm in listing a host twice in this case
    if mirror_server != data_server -%>
deb http://<%= mirror_server %>/<%= url_path -%> <%= suffix %>
<%  end
end

# restore the randomness
srand(old_seed)

end
-%>
